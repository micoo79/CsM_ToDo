<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CsM ToDo</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      font-size: 13px;
      background: #f0f0f0;
      color: #222;
    }

    /* === LOGIN === */
    .login-screen {
      position: fixed; inset: 0;
      background: #e8eaf0;
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .login-box {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 32px 28px;
      width: 100%; max-width: 340px;
      box-shadow: 0 4px 20px rgba(0,0,0,.12);
    }
    .login-box h2 {
      font-size: 18px; font-weight: 700;
      text-align: center; margin-bottom: 6px;
      color: #2e7d32;
    }
    .login-box .login-sub {
      text-align: center; color: #666; font-size: 12px; margin-bottom: 20px;
    }
    .login-box input {
      width: 100%; padding: 10px 12px; margin-bottom: 10px;
      background: #fff; border: 1px solid #ccc; border-radius: 4px;
      color: #222; font-size: 13px;
      outline: none;
    }
    .login-box input:focus { border-color: #2e7d32; box-shadow: 0 0 0 2px rgba(46,125,50,.15); }
    .login-box button {
      width: 100%; padding: 10px; margin-top: 4px;
      background: #2e7d32; border: none; border-radius: 4px;
      color: #fff; font-size: 13px; font-weight: 600;
      cursor: pointer;
    }
    .login-box button:hover { background: #256b29; }
    .login-box button:disabled { opacity: .5; cursor: wait; }
    .login-error { color: #c62828; font-size: 12px; margin-top: 10px; text-align: center; }

    /* === APP LAYOUT === */
    .app { display: none; height: 100vh; flex-direction: column; }

    /* Top bar */
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 12px;
      background: #2e7d32;
      color: #fff;
      flex-shrink: 0;
    }
    .topbar-left { display: flex; align-items: center; gap: 16px; }
    .topbar-brand { font-size: 15px; font-weight: 700; }
    .topbar-right { display: flex; align-items: center; gap: 10px; }
    .btn-logout {
      background: rgba(255,255,255,.15); border: 1px solid rgba(255,255,255,.3);
      color: #fff; padding: 4px 10px; border-radius: 4px; font-size: 11px;
      cursor: pointer;
    }
    .btn-logout:hover { background: rgba(255,255,255,.25); }
    .count-label { font-size: 11px; opacity: .8; }

    /* Toolbar */
    .toolbar {
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
      padding: 6px 12px;
      background: #fff;
      border-bottom: 1px solid #d0d0d0;
      flex-shrink: 0;
    }
    .toolbar-actions { display: flex; gap: 4px; }
    .tbtn {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 10px; border-radius: 4px;
      font-size: 12px; font-weight: 500;
      background: #e8f5e9; border: 1px solid #a5d6a7;
      color: #2e7d32; cursor: pointer;
    }
    .tbtn:hover { background: #c8e6c9; }
    .tbtn:disabled { opacity: .4; cursor: not-allowed; }
    .tbtn.danger { background: #ffebee; border-color: #ef9a9a; color: #c62828; }
    .tbtn.danger:hover { background: #ffcdd2; }
    .toolbar-spacer { flex: 1; }
    .toolbar-filters { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .toolbar-filters label { font-size: 11px; color: #666; }
    .toolbar-filters input[type="text"] {
      padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;
      font-size: 12px; width: 180px; outline: none;
    }
    .toolbar-filters input[type="text"]:focus { border-color: #2e7d32; }
    .toolbar-filters select {
      padding: 4px 6px; border: 1px solid #ccc; border-radius: 4px;
      font-size: 12px; outline: none; background: #fff;
    }
    .toolbar-filters input[type="checkbox"] { cursor: pointer; }

    /* === TABLE === */
    .table-wrap {
      flex: 1;
      overflow: auto;
      background: #fff;
    }
    table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
    }
    thead { position: sticky; top: 0; z-index: 10; }
    thead th {
      background: #2e7d32;
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      padding: 6px 8px;
      text-align: center;
      white-space: nowrap;
      border: 1px solid #1b5e20;
      position: relative;
      user-select: none;
    }
    thead th.col-text { text-align: left; }

    /* Year separator */
    .year-row td {
      background: #fff9c4;
      font-weight: 700;
      font-size: 13px;
      padding: 5px 10px;
      color: #5d4037;
      border: 1px solid #d0d0d0;
    }

    /* Data rows */
    tbody td {
      padding: 3px 6px;
      border: 1px solid #e0e0e0;
      vertical-align: middle;
      white-space: nowrap;
    }
    tbody tr { transition: background .1s; }
    tbody tr:hover { background: #e8f5e9 !important; }
    tbody tr.selected { background: #bbdefb !important; }
    tbody tr.fullrow { background: #e8f5e9; }
    tbody tr.parkrow { background: #f5f5f5; color: #999; }
    tbody tr.hiddenrow { background: #fff3e0; opacity: .6; }

    /* Checkbox cells */
    td.chk {
      text-align: center;
      padding: 3px 4px;
    }
    td.chk input[type="checkbox"] {
      width: 15px; height: 15px;
      cursor: pointer;
      accent-color: #2e7d32;
    }
    td.chk.ferc-on {
      background: #ffcdd2;
    }
    td.chk.ferc-on input { accent-color: #c62828; }

    /* Text input cells */
    td .cell-input {
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      font-size: 12px;
      font-family: inherit;
      padding: 2px 2px;
      color: inherit;
    }
    td .cell-input:focus {
      background: #e3f2fd;
      border-radius: 2px;
    }
    td .cell-input.name-input {
      font-weight: 600;
      min-width: 160px;
    }
    td .cell-input.num-input {
      text-align: right;
      min-width: 70px;
      font-variant-numeric: tabular-nums;
    }
    td .cell-input.note-input {
      min-width: 200px;
    }
    td .cell-input.mobil-input {
      min-width: 110px;
    }
    td .cell-input.munkaszam-input {
      min-width: 80px;
    }

    /* Column widths */
    .col-ho { width: 35px; text-align: center; }
    .col-name { min-width: 170px; }
    .col-num { width: 75px; text-align: right; }
    .col-chk { width: 30px; }
    .col-note { min-width: 210px; }
    .col-mobil { min-width: 120px; }
    .col-munkaszam { min-width: 85px; }
    /* Hide/show button */
    .tbtn.hide-toggle { background: #fff3e0; border-color: #ffcc80; color: #e65100; }
    .tbtn.hide-toggle:hover { background: #ffe0b2; }
    .tbtn.show-toggle { background: #e3f2fd; border-color: #90caf9; color: #1565c0; }
    .tbtn.show-toggle:hover { background: #bbdefb; }

    /* Year multi-select */
    .year-filter { position: relative; }
    .year-btn {
      padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;
      font-size: 12px; background: #fff; cursor: pointer;
      min-width: 80px; text-align: left;
      display: flex; align-items: center; justify-content: space-between; gap: 4px;
    }
    .year-btn:hover { border-color: #2e7d32; }
    .year-btn .arrow { font-size: 9px; color: #999; }
    .year-dropdown {
      display: none;
      position: absolute; top: 100%; left: 0;
      background: #fff; border: 1px solid #ccc; border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      z-index: 100; min-width: 100px;
      padding: 4px 0;
      margin-top: 2px;
    }
    .year-dropdown.open { display: block; }
    .year-dropdown label {
      display: flex; align-items: center; gap: 6px;
      padding: 4px 10px; cursor: pointer;
      font-size: 12px; color: #222;
    }
    .year-dropdown label:hover { background: #e8f5e9; }
    .year-dropdown input[type="checkbox"] { accent-color: #2e7d32; cursor: pointer; }

    /* Stats button */
    .tbtn.stats { background: #e8eaf6; border-color: #9fa8da; color: #283593; }
    .tbtn.stats:hover { background: #c5cae9; }

    /* Stats modal */
    .stats-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.4);
      display: none; align-items: center; justify-content: center;
      z-index: 300;
    }
    .stats-overlay.open { display: flex; }
    .stats-modal {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,.25);
      width: 90%; max-width: 600px;
      max-height: 80vh;
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    .stats-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 20px;
      background: #283593;
      color: #fff;
      font-size: 15px; font-weight: 700;
    }
    .stats-close {
      background: none; border: none; color: #fff;
      font-size: 20px; cursor: pointer; line-height: 1;
      padding: 0 4px;
    }
    .stats-close:hover { opacity: .7; }
    .stats-body {
      padding: 20px;
      overflow-y: auto;
    }
    .stats-year-block {
      margin-bottom: 20px;
    }
    .stats-year-block:last-child { margin-bottom: 0; }
    .stats-year-title {
      font-size: 14px; font-weight: 700;
      color: #283593;
      padding: 6px 0;
      border-bottom: 2px solid #c5cae9;
      margin-bottom: 10px;
    }
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .stats-table th {
      text-align: left;
      padding: 5px 8px;
      background: #e8eaf6;
      border: 1px solid #c5cae9;
      font-weight: 600;
      color: #333;
    }
    .stats-table td {
      padding: 5px 8px;
      border: 1px solid #e0e0e0;
    }
    .stats-table td.num {
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }
    .stats-table tr.total-row td {
      background: #e8f5e9;
      font-weight: 700;
      border-top: 2px solid #2e7d32;
    }
    .stats-table tr.avg-row td {
      background: #fff8e1;
      font-weight: 600;
      font-style: italic;
    }
    .stats-grand {
      margin-top: 16px;
      padding: 12px 16px;
      background: #e8f5e9;
      border: 1px solid #a5d6a7;
      border-radius: 6px;
      font-size: 13px;
    }
    .stats-grand b { color: #2e7d32; }

    /* Chart */
    .stats-chart-wrap {
      margin-bottom: 20px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    .stats-chart-title {
      font-size: 13px; font-weight: 700; color: #283593;
      margin-bottom: 8px; text-align: center;
    }
    .stats-chart-canvas {
      width: 100%; height: 260px;
      display: block;
    }

    /* Summary row */
    .summary-row td {
      background: #e0e0e0;
      font-weight: 700;
      font-size: 12px;
      padding: 5px 6px;
      border: 1px solid #bdbdbd;
    }

    /* Toast */
    .toast {
      position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
      padding: 6px 16px; border-radius: 20px;
      background: #333; color: #fff; font-size: 12px; font-weight: 500;
      box-shadow: 0 2px 12px rgba(0,0,0,.3);
      opacity: 0; pointer-events: none;
      transition: opacity .2s;
      z-index: 200;
    }
    .toast.show { opacity: 1; }

    /* Loading */
    .loading-msg {
      display: flex; align-items: center; justify-content: center;
      padding: 40px; color: #888; font-size: 13px; gap: 8px;
    }
    .spinner {
      width: 16px; height: 16px;
      border: 2px solid #ddd; border-top-color: #2e7d32;
      border-radius: 50%; animation: spin .6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 768px) {
      .toolbar-filters input[type="text"] { width: 120px; }
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div id="loginScreen" class="login-screen">
    <div class="login-box">
      <h2>CsM ToDo</h2>
      <div class="login-sub">Jelentkezz be a folytatáshoz</div>
      <form id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" required autocomplete="email" />
        <input type="password" id="loginPassword" placeholder="Jelszó" required autocomplete="current-password" />
        <button type="submit" id="loginBtn">Bejelentkezés</button>
        <div id="loginError" class="login-error"></div>
      </form>
    </div>
  </div>

  <!-- APP -->
  <div class="app" id="mainApp">
    <!-- Top bar -->
    <div class="topbar">
      <div class="topbar-left">
        <div class="topbar-brand">CsM ToDo</div>
      </div>
      <div class="topbar-right">
        <span class="count-label" id="countLabel">0 / 0</span>
        <button id="logoutBtn" class="btn-logout">Kijelentkezés</button>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-actions">
        <button id="addRow" class="tbtn" title="Új sor">+ Új</button>
        <button id="dupRow" class="tbtn" title="Duplikál" disabled>Duplikál</button>
        <button id="delRow" class="tbtn danger" title="Törlés" disabled>Törlés</button>
        <button id="hideRow" class="tbtn hide-toggle" title="Elrejtés / Megjelenítés" disabled>Elrejtés</button>
        <button id="statsBtn" class="tbtn stats" title="Statisztika">Statisztika</button>
      </div>
      <div class="toolbar-spacer"></div>
      <div class="toolbar-filters">
        <label>Keresés:</label>
        <input id="q" type="text" placeholder="Név / megjegyzés / mobil…" autocomplete="off" />
        <label>Év:</label>
        <div class="year-filter" id="yearFilter">
          <button type="button" class="year-btn" id="yearBtn">Mind <span class="arrow">&#9660;</span></button>
          <div class="year-dropdown" id="yearDropdown"></div>
        </div>
        <label>Hónap:</label>
        <select id="month">
          <option value="">Mind</option>
          <option value="1">Jan</option><option value="2">Feb</option><option value="3">Már</option>
          <option value="4">Ápr</option><option value="5">Máj</option><option value="6">Jún</option>
          <option value="7">Júl</option><option value="8">Aug</option><option value="9">Sze</option>
          <option value="10">Okt</option><option value="11">Nov</option><option value="12">Dec</option>
        </select>
        <label>Rejtett:</label>
        <input id="showHidden" type="checkbox" />
      </div>
    </div>

    <!-- Table -->
    <div class="table-wrap" id="tableWrap">
      <div class="loading-msg"><div class="spinner"></div> Betöltés...</div>
    </div>
  </div>

  <!-- Stats modal -->
  <div class="stats-overlay" id="statsOverlay">
    <div class="stats-modal">
      <div class="stats-header">
        <span>Bevétel statisztika</span>
        <button class="stats-close" id="statsClose">&times;</button>
      </div>
      <div class="stats-body" id="statsBody"></div>
    </div>
  </div>

  <div class="toast" id="toast">Mentve</div>

<script>
  // === SUPABASE CONFIG ===
  const SUPABASE_URL = 'https://jkgtnngehhkmatevsymo.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprZ3RubmdlaGhrbWF0ZXZzeW1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTA0NjMsImV4cCI6MjA4NTYyNjQ2M30.o6DbiL5ZN0CD-Obuftk_08Ii4t0uYWMqkJg5h5lt_vI';
  const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      storageKey: 'todo-auth',
      autoRefreshToken: true,
      detectSessionInUrl: false
    }
  });

  // === AUTH ===
  const loginScreen = document.getElementById('loginScreen');
  const mainApp = document.getElementById('mainApp');
  const loginForm = document.getElementById('loginForm');
  const loginEmail = document.getElementById('loginEmail');
  const loginPassword = document.getElementById('loginPassword');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');
  const logoutBtn = document.getElementById('logoutBtn');

  function showLogin() {
    loginScreen.style.display = 'flex';
    mainApp.style.display = 'none';
  }
  function showApp() {
    loginScreen.style.display = 'none';
    mainApp.style.display = 'flex';
  }

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    loginBtn.disabled = true;
    loginBtn.textContent = 'Bejelentkezés...';
    loginError.textContent = '';
    const { data, error } = await db.auth.signInWithPassword({
      email: loginEmail.value,
      password: loginPassword.value
    });
    if (error) {
      loginError.textContent = 'Hibás email vagy jelszó';
      loginBtn.disabled = false;
      loginBtn.textContent = 'Bejelentkezés';
      return;
    }
    showApp();
    startApp();
  });

  logoutBtn.addEventListener('click', async () => {
    await db.auth.signOut();
    showLogin();
    rows = [];
  });

  (async function checkAuth() {
    const { data: { session } } = await db.auth.getSession();
    if (session) { showApp(); startApp(); }
    else { showLogin(); }
  })();

  // === HELPERS ===
  const nowIso = () => new Date().toISOString().slice(0,19).replace('T',' ');
  const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2)+Date.now());

  function getMonth(r) {
    if (r.date) { const m = new Date(r.date).getMonth() + 1; return isNaN(m) ? null : m; }
    return r.month || null;
  }

  function fmtNum(n) {
    if (n === null || n === undefined || n === "") return "";
    const x = Number(n);
    if (!Number.isFinite(x)) return "";
    return x.toLocaleString('hu-HU');
  }
  function parseNum(s) {
    const t = String(s ?? "").trim();
    if (!t) return null;
    const cleaned = t.replace(/\s/g,'').replace(/,/g,'.');
    const x = Number(cleaned);
    return Number.isFinite(x) ? x : null;
  }

  // === SUPABASE DATA ===
  async function loadRowsFromSupabase() {
    try {
      const { data, error } = await db.from('jobs').select('*').order('date', { ascending: false });
      if (error) throw error;
      return data.map(r => ({ ...r, month: getMonth(r), full: r.is_full, kint: r.is_kint }));
    } catch(e) { console.error('Supabase load error:', e); return null; }
  }

  async function saveRowToSupabase(row) {
    try {
      const dbRow = { ...row, is_full: row.full ?? row.is_full ?? false, is_kint: row.kint ?? row.is_kint ?? false, updated_at: new Date().toISOString() };
      delete dbRow.full; delete dbRow.kint; delete dbRow.month;
      const { data, error } = await db.from('jobs').upsert(dbRow, { onConflict: 'id' }).select();
      if (error) throw error;
      return data?.[0];
    } catch(e) { console.error('Supabase save error:', e); return null; }
  }

  async function deleteRowFromSupabase(id) {
    try {
      const { error } = await db.from('jobs').delete().eq('id', id);
      if (error) throw error;
      return true;
    } catch(e) { console.error('Supabase delete error:', e); return false; }
  }

  let _dirtyRows = new Set();
  function scheduleSave(row) {
    if (row?.id) _dirtyRows.add(row.id);
    clearTimeout(scheduleSave._t);
    scheduleSave._t = setTimeout(async () => {
      for (const id of _dirtyRows) {
        const r = rows.find(x => x.id === id);
        if (r) await saveRowToSupabase(r);
      }
      _dirtyRows.clear();
    }, 500);
  }

  // === STATE ===
  let rows = [];
  let selectedId = null;

  const tableWrap = document.getElementById('tableWrap');
  const qEl = document.getElementById('q');
  const monthEl = document.getElementById('month');
  const showHiddenEl = document.getElementById('showHidden');
  const countLabel = document.getElementById('countLabel');

  // Year multi-select
  const yearBtn = document.getElementById('yearBtn');
  const yearDropdown = document.getElementById('yearDropdown');
  let selectedYears = new Set(); // empty = all

  const btnAdd = document.getElementById('addRow');
  const btnDup = document.getElementById('dupRow');
  const btnDel = document.getElementById('delRow');
  const btnHide = document.getElementById('hideRow');
  const toast = document.getElementById('toast');

  function quickToast(msg) {
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(quickToast._t);
    quickToast._t = setTimeout(() => toast.classList.remove('show'), 650);
  }

  // === CHECKBOX COLUMNS ===
  const CHK_COLS = [
    { key: 'offer_sent',  label: 'Ajánlat' },
    { key: 'accepted',    label: 'Elfogadva' },
    { key: 'paid',        label: 'Fizetve' },
    { key: 'terep',       label: 'Terep' },
    { key: 'ferc',        label: 'Férc' },
    { key: 'igenyelve',   label: 'igényelve' },
    { key: 'utalva',      label: 'utalva' },
    { key: 'kiadva',      label: 'kiadva' },
    { key: 'beadva',      label: 'Beadva' },
    { key: 'email_chk',   label: 'email' },
    { key: 'utalas_chk',  label: 'Utalás' },
    { key: 'full',        label: 'FULL', saveKey: 'is_full' },
    { key: 'parkolo',     label: 'parkoló' },
  ];

  const EXTRA_CHK = [
    { key: 'feltoltes',   label: 'feltöltés' },
    { key: 'szamla_ment', label: 'számla ment' },
    { key: 'szamlas',     label: 'Számlás' },
  ];

  // === FILTERS ===
  [qEl, monthEl, showHiddenEl].forEach(el => {
    if (!el) return;
    el.addEventListener('input', render);
    el.addEventListener('change', render);
  });

  // Year dropdown toggle
  yearBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    yearDropdown.classList.toggle('open');
  });
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#yearFilter')) yearDropdown.classList.remove('open');
  });

  function updateYearBtnLabel() {
    if (selectedYears.size === 0) {
      yearBtn.innerHTML = 'Mind <span class="arrow">&#9660;</span>';
    } else {
      const yrs = Array.from(selectedYears).sort((a,b) => b - a).join(', ');
      yearBtn.innerHTML = yrs + ' <span class="arrow">&#9660;</span>';
    }
  }

  function populateYearFilter() {
    const years = new Set();
    rows.forEach(r => { if (r.date) { const y = new Date(r.date).getFullYear(); if (y) years.add(y); } });
    const sorted = Array.from(years).sort((a,b) => b - a);
    yearDropdown.innerHTML = '';
    for (const y of sorted) {
      const lbl = document.createElement('label');
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.value = y;
      chk.checked = selectedYears.has(String(y));
      chk.addEventListener('change', () => {
        if (chk.checked) selectedYears.add(String(y));
        else selectedYears.delete(String(y));
        updateYearBtnLabel();
        render();
      });
      lbl.appendChild(chk);
      lbl.appendChild(document.createTextNode(' ' + y));
      yearDropdown.appendChild(lbl);
    }
  }

  function passesFilters(r) {
    const showHidden = !!showHiddenEl?.checked;
    if (!showHidden && r.hidden) return false;
    if (selectedYears.size > 0 && r.date) {
      const yr = String(new Date(r.date).getFullYear());
      if (!selectedYears.has(yr)) return false;
    }
    const m = monthEl?.value ? String(monthEl.value) : "";
    if (m && String(r.month ?? "") !== m) return false;
    const q = (qEl?.value || "").trim().toLowerCase();
    if (q) {
      const hay = [r.short_name ?? "", r.note ?? "", r.munkaszam ?? "", r.mobil ?? "", String(r.month ?? "")].join(" ").toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  }

  // === RENDER TABLE ===
  function render() {
    const filtered = rows.filter(passesFilters);

    // Group by year
    const byYear = {};
    for (const r of filtered) {
      const yr = r.date ? new Date(r.date).getFullYear() : 'Egyéb';
      if (!byYear[yr]) byYear[yr] = [];
      byYear[yr].push(r);
    }
    // Sort years descending
    const sortedYears = Object.keys(byYear).sort((a,b) => {
      if (a === 'Egyéb') return 1;
      if (b === 'Egyéb') return -1;
      return Number(b) - Number(a);
    });

    // Build table
    const table = document.createElement('table');

    // Header
    const thead = document.createElement('thead');
    const hRow = document.createElement('tr');
    const headers = [
      { label: 'Hó', cls: 'col-ho' },
      { label: 'Rövid név', cls: 'col-name col-text' },
      { label: 'Munkadíj', cls: 'col-num' },
      { label: 'Költség', cls: 'col-num' },
    ];
    CHK_COLS.forEach(c => headers.push({ label: c.label, cls: 'col-chk' }));
    headers.push({ label: 'Megjegyzés', cls: 'col-note col-text' });
    headers.push({ label: 'Mobil', cls: 'col-mobil col-text' });
    headers.push({ label: 'Munkaszám', cls: 'col-munkaszam col-text' });
    EXTRA_CHK.forEach(c => headers.push({ label: c.label, cls: 'col-chk' }));

    for (const h of headers) {
      const th = document.createElement('th');
      th.textContent = h.label;
      th.className = h.cls || '';
      hRow.appendChild(th);
    }
    thead.appendChild(hRow);
    table.appendChild(thead);

    // Body
    const tbody = document.createElement('tbody');

    const totalCols = headers.length;

    for (const yr of sortedYears) {
      // Year separator row
      const yrRow = document.createElement('tr');
      yrRow.className = 'year-row';
      const yrTd = document.createElement('td');
      yrTd.colSpan = totalCols;
      yrTd.textContent = yr;
      yrRow.appendChild(yrTd);
      tbody.appendChild(yrRow);

      // Sort rows within year by month
      const yearRows = byYear[yr].sort((a,b) => (a.month||0) - (b.month||0));

      for (const r of yearRows) {
        const tr = document.createElement('tr');
        tr.dataset.id = r.id;

        // Row state
        if (r.id === selectedId) tr.classList.add('selected');
        if (r.full) tr.classList.add('fullrow');
        if (r.parkolo && !r.full) tr.classList.add('parkrow');
        if (r.hidden) tr.classList.add('hiddenrow');

        // Click to select
        tr.addEventListener('click', (e) => {
          if (e.target.closest('input')) return;
          selectedId = (selectedId === r.id) ? null : r.id;
          renderSelection();
        });

        // === Hó ===
        const tdHo = document.createElement('td');
        tdHo.className = 'col-ho';
        tdHo.textContent = r.month || '';
        tr.appendChild(tdHo);

        // === Rövid név ===
        const tdName = document.createElement('td');
        tdName.className = 'col-name';
        const nameInp = document.createElement('input');
        nameInp.className = 'cell-input name-input';
        nameInp.type = 'text';
        nameInp.value = r.short_name || '';
        nameInp.addEventListener('blur', () => {
          if ((r.short_name ?? '') !== nameInp.value) {
            r.short_name = nameInp.value;
            r.updated_at = nowIso();
            scheduleSave(r);
            quickToast('Mentve');
          }
        });
        nameInp.addEventListener('keydown', e => { if (e.key === 'Enter') nameInp.blur(); });
        tdName.appendChild(nameInp);
        tr.appendChild(tdName);

        // === Munkadíj ===
        const tdFee = document.createElement('td');
        tdFee.className = 'col-num';
        const feeInp = document.createElement('input');
        feeInp.className = 'cell-input num-input';
        feeInp.type = 'text';
        feeInp.inputMode = 'numeric';
        feeInp.value = fmtNum(r.fee);
        feeInp.addEventListener('focus', () => { feeInp.value = r.fee ?? ''; });
        feeInp.addEventListener('blur', () => {
          const parsed = parseNum(feeInp.value);
          if ((r.fee ?? null) !== parsed) {
            r.fee = parsed;
            r.updated_at = nowIso();
            scheduleSave(r);
            quickToast('Mentve');          }
          feeInp.value = fmtNum(r.fee);
        });
        feeInp.addEventListener('keydown', e => { if (e.key === 'Enter') feeInp.blur(); });
        tdFee.appendChild(feeInp);
        tr.appendChild(tdFee);

        // === Költség ===
        const tdCost = document.createElement('td');
        tdCost.className = 'col-num';
        const costInp = document.createElement('input');
        costInp.className = 'cell-input num-input';
        costInp.type = 'text';
        costInp.inputMode = 'numeric';
        costInp.value = fmtNum(r.cost);
        costInp.addEventListener('focus', () => { costInp.value = r.cost ?? ''; });
        costInp.addEventListener('blur', () => {
          const parsed = parseNum(costInp.value);
          if ((r.cost ?? null) !== parsed) {
            r.cost = parsed;
            r.updated_at = nowIso();
            scheduleSave(r);
            quickToast('Mentve');          }
          costInp.value = fmtNum(r.cost);
        });
        costInp.addEventListener('keydown', e => { if (e.key === 'Enter') costInp.blur(); });
        tdCost.appendChild(costInp);
        tr.appendChild(tdCost);

        // === Checkbox columns ===
        for (const col of CHK_COLS) {
          const td = document.createElement('td');
          td.className = 'chk';
          if (col.key === 'ferc' && r.ferc) td.classList.add('ferc-on');
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.checked = !!r[col.key];
          chk.addEventListener('change', () => {
            r[col.key] = chk.checked;
            r.updated_at = nowIso();
            scheduleSave(r);
            quickToast('Mentve');
            // Update ferc cell styling
            if (col.key === 'ferc') {
              td.classList.toggle('ferc-on', chk.checked);
            }
            // Handle full/parkolo mutual exclusivity
            if (col.key === 'full' && chk.checked) {
              r.parkolo = false;
              render();
              return;
            }
            if (col.key === 'parkolo' && chk.checked) {
              r.full = false;
              render();
              return;
            }
            if (col.key === 'full' || col.key === 'parkolo') {
              render();
              return;
            }          });
          td.appendChild(chk);
          tr.appendChild(td);
        }

        // === Megjegyzés ===
        const tdNote = document.createElement('td');
        tdNote.className = 'col-note';
        const noteInp = document.createElement('input');
        noteInp.className = 'cell-input note-input';
        noteInp.type = 'text';
        noteInp.value = r.note || '';
        noteInp.addEventListener('blur', () => {
          if ((r.note ?? '') !== noteInp.value) {
            r.note = noteInp.value;
            r.updated_at = nowIso();
            scheduleSave(r);
            quickToast('Mentve');
          }
        });
        noteInp.addEventListener('keydown', e => { if (e.key === 'Enter') noteInp.blur(); });
        tdNote.appendChild(noteInp);
        tr.appendChild(tdNote);

        // === Mobil ===
        const tdMobil = document.createElement('td');
        tdMobil.className = 'col-mobil';
        const mobilInp = document.createElement('input');
        mobilInp.className = 'cell-input mobil-input';
        mobilInp.type = 'text';
        mobilInp.value = r.mobil || '';
        mobilInp.addEventListener('blur', () => {
          if ((r.mobil ?? '') !== mobilInp.value) {
            r.mobil = mobilInp.value;
            r.updated_at = nowIso();
            scheduleSave(r);
            quickToast('Mentve');
          }
        });
        mobilInp.addEventListener('keydown', e => { if (e.key === 'Enter') mobilInp.blur(); });
        tdMobil.appendChild(mobilInp);
        tr.appendChild(tdMobil);

        // === Munkaszám ===
        const tdMsz = document.createElement('td');
        tdMsz.className = 'col-munkaszam';
        const mszInp = document.createElement('input');
        mszInp.className = 'cell-input munkaszam-input';
        mszInp.type = 'text';
        mszInp.value = r.munkaszam || '';
        mszInp.addEventListener('blur', () => {
          if ((r.munkaszam ?? '') !== mszInp.value) {
            r.munkaszam = mszInp.value;
            r.updated_at = nowIso();
            scheduleSave(r);
            quickToast('Mentve');
          }
        });
        mszInp.addEventListener('keydown', e => { if (e.key === 'Enter') mszInp.blur(); });
        tdMsz.appendChild(mszInp);
        tr.appendChild(tdMsz);

        // === Extra checkboxes (feltöltés, számla ment, számlás) ===
        for (const col of EXTRA_CHK) {
          const td = document.createElement('td');
          td.className = 'chk';
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.checked = !!r[col.key];
          chk.addEventListener('change', () => {
            r[col.key] = chk.checked;
            r.updated_at = nowIso();
            scheduleSave(r);
            quickToast('Mentve');
          });
          td.appendChild(chk);
          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      }
    }

    table.appendChild(tbody);

    tableWrap.innerHTML = '';
    tableWrap.appendChild(table);

    countLabel.textContent = `${filtered.length} / ${rows.length}`;
    renderSelection();
  }

  function renderSelection() {
    document.querySelectorAll('tbody tr[data-id]').forEach(tr => {
      tr.classList.toggle('selected', tr.dataset.id === selectedId);
    });
    btnDup.disabled = !selectedId;
    btnDel.disabled = !selectedId;
    btnHide.disabled = !selectedId;
    // Update hide button label
    if (selectedId) {
      const r = rows.find(x => x.id === selectedId);
      if (r && r.hidden) {
        btnHide.textContent = 'Megjelenít';
        btnHide.className = 'tbtn show-toggle';
      } else {
        btnHide.textContent = 'Elrejtés';
        btnHide.className = 'tbtn hide-toggle';
      }
    } else {
      btnHide.textContent = 'Elrejtés';
      btnHide.className = 'tbtn hide-toggle';
    }
  }

  // === TOOLBAR ACTIONS ===
  btnAdd.addEventListener('click', () => {
    const now = new Date();
    const r = {
      id: uid(),
      date: `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`,
      month: now.getMonth() + 1,
      short_name:'', fee:null, cost:null,
      offer_sent:false, accepted:false, paid:false,
      terep:false, ferc:false,
      igenyelve:false, utalva:false, kiadva:false,
      beadva:false, email_chk:false, utalas_chk:false,
      full:false, parkolo:false, hidden:false,
      note:'', mobil:'',
      feltoltes:false, szamla_ment:false,
      munkaszam:'', kint:false, col_1420000:null, szamlas:false,
      updated_at: nowIso()
    };
    rows.unshift(r);
    selectedId = r.id;
    scheduleSave(r);
    quickToast('Új sor');
    render();
    // Focus on name input of new row
    setTimeout(() => {
      const newRow = document.querySelector(`tr[data-id="${r.id}"] .name-input`);
      if (newRow) newRow.focus();
    }, 50);
  });

  btnDup.addEventListener('click', () => {
    if (!selectedId) return;
    const p = rows.find(r => r.id === selectedId);
    if (!p) return;
    const copy = JSON.parse(JSON.stringify(p));
    copy.id = uid();
    copy.updated_at = nowIso();
    rows.unshift(copy);
    selectedId = copy.id;
    scheduleSave(copy);
    quickToast('Duplikálva');
    render();
  });

  btnDel.addEventListener('click', async () => {
    if (!selectedId) return;
    if (!confirm('Biztosan törlöd?')) return;
    const success = await deleteRowFromSupabase(selectedId);
    if (success) {
      rows = rows.filter(r => r.id !== selectedId);
      selectedId = null;
      quickToast('Törölve');
      render();
    } else { quickToast('Hiba törléskor'); }
  });

  btnHide.addEventListener('click', () => {
    if (!selectedId) return;
    const r = rows.find(x => x.id === selectedId);
    if (!r) return;
    r.hidden = !r.hidden;
    r.updated_at = nowIso();
    scheduleSave(r);
    quickToast(r.hidden ? 'Elrejtve' : 'Láthatóvá téve');
    render();
  });

  // === STATS MODAL ===
  const statsBtn = document.getElementById('statsBtn');
  const statsOverlay = document.getElementById('statsOverlay');
  const statsClose = document.getElementById('statsClose');
  const statsBody = document.getElementById('statsBody');

  statsBtn.addEventListener('click', () => {
    renderStats();
    statsOverlay.classList.add('open');
  });
  statsClose.addEventListener('click', () => statsOverlay.classList.remove('open'));
  statsOverlay.addEventListener('click', (e) => {
    if (e.target === statsOverlay) statsOverlay.classList.remove('open');
  });

  function renderStats() {
    // Only count rows where paid === true
    const paidRows = rows.filter(r => r.paid);

    // Group by year
    const byYear = {};
    for (const r of paidRows) {
      const yr = r.date ? new Date(r.date).getFullYear() : null;
      if (!yr) continue;
      if (!byYear[yr]) byYear[yr] = [];
      byYear[yr].push(r);
    }

    const sortedYears = Object.keys(byYear).sort((a,b) => Number(b) - Number(a));

    let html = '';
    let grandTotal = 0;
    let grandCount = 0;

    for (const yr of sortedYears) {
      const yearRows = byYear[yr];

      // Group by month
      const byMonth = {};
      for (const r of yearRows) {
        const m = r.month || 0;
        if (!byMonth[m]) byMonth[m] = [];
        byMonth[m].push(r);
      }

      const monthNames = ['','Jan','Feb','Már','Ápr','Máj','Jún','Júl','Aug','Sze','Okt','Nov','Dec'];
      const sortedMonths = Object.keys(byMonth).map(Number).sort((a,b) => a - b);

      let yearTotal = 0;
      let monthRows = '';

      for (const m of sortedMonths) {
        const mrs = byMonth[m];
        let monthSum = 0;
        for (const r of mrs) {
          const fee = Number(r.fee) || 0;
          const cost = Number(r.cost) || 0;
          monthSum += fee - cost;
        }
        yearTotal += monthSum;
        const label = m >= 1 && m <= 12 ? monthNames[m] : 'Ismeretlen';
        monthRows += `<tr>
          <td>${label}</td>
          <td class="num">${mrs.length} db</td>
          <td class="num">${monthSum.toLocaleString('hu-HU')} Ft</td>
        </tr>`;
      }

      const activeMonthCount = sortedMonths.length;
      const monthlyAvg = activeMonthCount > 0 ? Math.round(yearTotal / activeMonthCount) : 0;
      grandTotal += yearTotal;
      grandCount += yearRows.length;

      html += `<div class="stats-year-block">
        <div class="stats-year-title">${yr}</div>
        <table class="stats-table">
          <thead><tr><th>Hónap</th><th style="text-align:right">Rekordok</th><th style="text-align:right">Bevétel</th></tr></thead>
          <tbody>
            ${monthRows}
            <tr class="total-row">
              <td>Összesen</td>
              <td class="num">${yearRows.length} db</td>
              <td class="num">${yearTotal.toLocaleString('hu-HU')} Ft</td>
            </tr>
            <tr class="avg-row">
              <td>Havi átlag</td>
              <td class="num">${activeMonthCount} hónap</td>
              <td class="num">${monthlyAvg.toLocaleString('hu-HU')} Ft</td>
            </tr>
          </tbody>
        </table>
      </div>`;
    }

    if (sortedYears.length === 0) {
      html = '<p style="color:#888;text-align:center;padding:20px;">Nincs fizetve jelölt rekord.</p>';
    } else {
      // Chart placeholder before tables
      const chartHtml = `<div class="stats-chart-wrap">
        <div class="stats-chart-title">Éves bevételek</div>
        <canvas class="stats-chart-canvas" id="revenueChart"></canvas>
      </div>`;
      html = chartHtml + html;

      html += `<div class="stats-grand">
        Összes bevétel (minden év): <b>${grandTotal.toLocaleString('hu-HU')} Ft</b> &mdash; ${grandCount} fizetve rekord
      </div>`;
    }

    statsBody.innerHTML = html;

    // Draw chart if data exists
    if (sortedYears.length > 0) {
      const chartYears = sortedYears.map(Number).sort((a,b) => a - b);
      const chartValues = chartYears.map(yr => {
        const yearRows = byYear[yr];
        let total = 0;
        for (const r of yearRows) {
          total += (Number(r.fee) || 0) - (Number(r.cost) || 0);
        }
        return total;
      });
      drawRevenueChart('revenueChart', chartYears, chartValues);
    }
  }

  function drawRevenueChart(canvasId, labels, values) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    const W = rect.width;
    const H = rect.height;

    const padLeft = 70, padRight = 20, padTop = 16, padBottom = 36;
    const chartW = W - padLeft - padRight;
    const chartH = H - padTop - padBottom;

    const maxVal = Math.max(...values, 0);
    const minVal = Math.min(...values, 0);
    const range = (maxVal - minVal) || 1;

    // Gridlines
    const gridSteps = 5;
    ctx.strokeStyle = '#d0d0d0';
    ctx.lineWidth = 0.5;
    ctx.fillStyle = '#666';
    ctx.font = '11px -apple-system, sans-serif';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    for (let i = 0; i <= gridSteps; i++) {
      const val = minVal + (range * i / gridSteps);
      const y = padTop + chartH - (chartH * (val - minVal) / range);
      ctx.beginPath();
      ctx.moveTo(padLeft, y);
      ctx.lineTo(padLeft + chartW, y);
      ctx.stroke();
      ctx.fillText(Math.round(val).toLocaleString('hu-HU'), padLeft - 6, y);
    }

    // Zero line
    if (minVal < 0) {
      const zeroY = padTop + chartH - (chartH * (0 - minVal) / range);
      ctx.strokeStyle = '#999';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padLeft, zeroY);
      ctx.lineTo(padLeft + chartW, zeroY);
      ctx.stroke();
    }

    // Bars
    const barCount = labels.length;
    const barGap = Math.max(6, chartW * 0.08 / barCount);
    const barW = Math.min(60, (chartW - barGap * (barCount + 1)) / barCount);
    const totalBarsW = barCount * barW + (barCount + 1) * barGap;
    const offsetX = padLeft + (chartW - totalBarsW) / 2;

    const zeroY = padTop + chartH - (chartH * (0 - minVal) / range);

    ctx.font = '11px -apple-system, sans-serif';
    ctx.textAlign = 'center';

    for (let i = 0; i < barCount; i++) {
      const x = offsetX + barGap * (i + 1) + barW * i;
      const val = values[i];
      const valY = padTop + chartH - (chartH * (val - minVal) / range);

      // Bar
      const barTop = Math.min(valY, zeroY);
      const barH = Math.abs(valY - zeroY);
      const grad = ctx.createLinearGradient(x, barTop, x, barTop + barH);
      if (val >= 0) {
        grad.addColorStop(0, '#43a047');
        grad.addColorStop(1, '#2e7d32');
      } else {
        grad.addColorStop(0, '#e53935');
        grad.addColorStop(1, '#c62828');
      }
      ctx.fillStyle = grad;
      ctx.beginPath();
      const radius = Math.min(4, barW / 4, barH / 2);
      if (barH > 0) {
        ctx.moveTo(x + radius, barTop);
        ctx.lineTo(x + barW - radius, barTop);
        ctx.quadraticCurveTo(x + barW, barTop, x + barW, barTop + radius);
        ctx.lineTo(x + barW, barTop + barH);
        ctx.lineTo(x, barTop + barH);
        ctx.lineTo(x, barTop + radius);
        ctx.quadraticCurveTo(x, barTop, x + radius, barTop);
      }
      ctx.fill();

      // Value on top
      ctx.fillStyle = '#333';
      ctx.font = 'bold 11px -apple-system, sans-serif';
      const valText = (val / 1000000).toFixed(1) + 'M';
      const labelY = val >= 0 ? barTop - 6 : barTop + barH + 14;
      ctx.fillText(valText, x + barW / 2, labelY);

      // Year label
      ctx.fillStyle = '#444';
      ctx.font = '12px -apple-system, sans-serif';
      ctx.fillText(String(labels[i]), x + barW / 2, H - padBottom + 18);
    }
  }

  // Keyboard shortcuts
  window.addEventListener('keydown', (e) => {
    if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
      const t = document.activeElement?.tagName;
      if (t === 'INPUT' || t === 'TEXTAREA' || t === 'SELECT') return;
      e.preventDefault();
      qEl?.focus();
    }
    if (e.key === 'Escape' && document.activeElement === qEl) {
      qEl.value = '';
      render();
    }
  });

  // === START ===
  async function startApp() {
    tableWrap.innerHTML = '<div class="loading-msg"><div class="spinner"></div> Betöltés...</div>';
    const loaded = await loadRowsFromSupabase();
    rows = (loaded && loaded.length) ? loaded : [];
    populateYearFilter();
    render();
  }
</script>
</body>
</html>
